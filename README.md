# ü§ñ Persuasion Bot
An LLM-based chatbot that takes in messages from a user, processes them, and generates responses intended to defend itself or maintain its position during an ongoing conversation.

## üìú Table of Contents
1. [Overview](#overview)
2. [Architecture](#architecture)
3. [Entities](#entities)
4. [Folder Structure](#folder-structure)
5. [Tech Stack](#tech-stack)
6. [Getting Started](#getting-started)
7. [API Documentation](#api-documentation)
8. [Example Requests](#example-requests)
9. [Non Functional Requirements](#non-functional-requirements)
10. [Database Optimization](#database-optimization)
11. [Production Considerations](#production-considerations)
12. [LLM](#llm)
13. [Deployment Guide](#deployment-guide)

---

## Overview
This application challenges you to persuade a chatbot to adopt your point of view while it stands its ground on the initial stance.

Includes:
- Single endpoint to handle messages and responses.
- Conversation history capped at the 5 most recent user+bot pairs.

---

## Architecture
![Architecture Diagram](docs/architecture.png?v=2)

- **Client**: Anyone consuming the API.
- **API**: REST API built with FastAPI.
- **Database**: PostgreSQL.
- **Cache**: Redis Cache to improve latency and enable rate limiting.

---

## Entities
![Entities](docs/entities.png)

**Messages**
- `id`: autogenerated
- `conversation_id`: related conversation
- `message`: content
- `role`: (user, bot)
- `timestamps`

**Conversations**
- `id`: autogenerated
- `side`: bot stance (con, pro)
- `topic`: discussion subject
- `timestamps`

---

## Folder Structure
```text
persuasion_bot/
‚îú‚îÄ‚îÄ app/                # Main application code (API, domain logic, adapters, services)
‚îú‚îÄ‚îÄ docs/               # Project documentation (guides, architecture diagrams, notes)
‚îú‚îÄ‚îÄ migrations/         # Database migration scripts (likely using Yoyo)
‚îú‚îÄ‚îÄ tests/              # Unit and integration tests for the project
‚îú‚îÄ‚îÄ .dockerignore       # Files/folders excluded when building Docker images
‚îú‚îÄ‚îÄ .env.example        # Example environment variables template
‚îú‚îÄ‚îÄ .gitignore          # Specifies files ignored by Git
‚îú‚îÄ‚îÄ Dockerfile          # Instructions to build the Docker container
‚îú‚îÄ‚îÄ Makefile            # Automation commands (run, test, migrate, etc.)
‚îú‚îÄ‚îÄ README.md           # Project overview, installation, usage instructions
‚îú‚îÄ‚îÄ docker-compose.yml  # Multi-container setup (API, DB, etc.) for local/dev
‚îú‚îÄ‚îÄ requirements.txt    # Python dependencies list
‚îî‚îÄ‚îÄ yoyo.ini            # Configuration for Yoyo database migrations
```

---

## Tech Stack
- **Backend**: FastAPI (Python 3.9+)
- **Database**: PostgreSQL
- **API Docs**: Swagger UI / ReDoc (auto-generated)
- **Containerization**: Docker

---

## Getting Started

### Prerequisites
- Docker (required) ‚Üí [Install Guide](https://docs.docker.com/engine/install/)
- GNU Make (required) ‚Üí [Install Guide](https://www.gnu.org/software/make/)

- Python & pip (optional, for local dev/tests)
- PostgreSQL (optional, for local dev)

### Clone Repository
```bash
git clone https://github.com/gonzasestopal/persuasion_bot.git
cd persuasion_bot
```

### Environment
Copy `.env.example` to `.env`:
```
DATABASE_URL=postgresql://app:app@db:5432/app
OPENAI_API_KEY=key
LLM_PROVIDER=openai
LLM_MODEL=gpt-4o
DIFFICULTY=easy|medium
```

### Running the service
```bash
make run
```

### Running tests
```bash
make test
```

### Cleanup
```bash
make down   # stop Docker services
make clean  # remove venv, caches
```

---

## API Documentation

Base URL:
- **Local:** `http://localhost:8000`

No authentication required.

### Messages
| Method | Endpoint    | Description                       |
|--------|------------|-----------------------------------|
| `POST` | `/messages`| Inserts a new message / Starts convo |

---

## Example Requests

> [!IMPORTANT]
> First message must include `topic` and `side` (PRO, CON).

**Start a new conversation**
```http
POST /messages
```
```json
{
  "conversation_id": null,
  "message": "Topic: Sports build discipline and community. Side: PRO."
}
```

**Continue a conversation**
```json
{
  "conversation_id": 1,
  "message": "But sports also divide people"
}
```

---

## Non Functional Requirements
- **Latency**: < 30s response, 25s internal timeout.
- **Scalability**: Redis caching for LLM + history.
- **History Window**: last 5 user+bot pairs only.
- **Fault Tolerance**: fallback short replies on timeout.
- **Storage**: conversations expire after 60m inactivity.

---

<details>
  <summary>‚ö° Database Optimization (click to expand)</summary>

- **conversations (expires_at)**
  Speeds up lookups for active conversations.

- **messages (conversation_id, created_at)**
  Optimizes retrieval of the last N messages.

- **messages (conversation_id, created_at DESC, id DESC)**
  Optimizes ‚Äúlatest N‚Äù queries with deterministic ordering.

</details>

---

<details>
  <summary>üõ°Ô∏è Production Considerations (click to expand)</summary>

- Expired conversations not physically deleted (cleanup job needed in prod).
- Use **atomic transactions** to store user+bot messages together.

**Caching Strategy**
1. **Idempotency keys** ‚Üí prevent retries from duplicating.
2. **Conversation history cache** ‚Üí Redis, TTL 30‚Äì60m.
3. **LLM reply cache** ‚Üí hash-based key, TTL 1‚Äì24h.

</details>

---

<details>
  <summary>üß† LLM Details (click to expand)</summary>

We support **OpenAI GPT-4o** and **Anthropic Claude 3.5**.

- **Prompt budget:** ‚â§ 3k tokens.
- **Output cap:** ~80‚Äì120 tokens.
- **Window:** last 5 user+bot pairs included.

**GPT-4o**
- Fastest, first tokens in 1‚Äì2s, usually <10s for full reply.

**Claude 3.5 Sonnet**
- More conversational, <10s medium replies, slightly slower than GPT-4o.

**Claude 3.5 Opus**
- Excluded (too slow, can exceed 30s SLA).

</details>

---

<details>
  <summary>üöÄ Deployment Guide (click to expand)</summary>

1. Provision **PostgreSQL** (Supabase/Neon/etc.).

2. Build & push Docker image:
   ```bash
   docker build -t gonzasestopal/persuasion-bot:v1 .
   docker push gonzasestopal/persuasion-bot:v1
   ```

3. Configure env vars in PaaS:
   ```
   DATABASE_URL=postgres://...
   OPENAI_API_KEY=your_api_key
   ```

4. Deploy container image.

5. Run migrations:
   ```bash
   make migrate
   ```

</details>
